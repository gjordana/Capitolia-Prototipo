<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Capitolia · Producto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    .page-title{display:flex;align-items:center;gap:.6rem;margin:1.25rem 0}
    .page-title i{font-size:28px}
    .img-preview{width:140px;height:140px;object-fit:cover;border-radius:.5rem;border:1px solid rgba(0,0,0,.1)}
    .field-note{font-size:.875rem;color:#6c757d}
    .badge-in{background:#e7f5ef;color:#0f5132;border:1px solid #a3cfbb}
    .badge-out{background:#fde7ea;color:#842029;border:1px solid #f1aeb5}
    .qty-in{color:#198754;font-weight:600}
    .qty-out{color:#dc3545;font-weight:600}
    .table thead th{white-space:nowrap}
    .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid rgba(0,0,0,.075);padding:.75rem}
    .pagination .page-link{cursor:pointer}
    .filter-pills .nav-link{border:1px solid rgba(0,0,0,.125)}
    .filter-pills .nav-link.active{background:#0d6efd;border-color:#0d6efd}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>
  <!-- Menú reusable -->
  <cap-menu></cap-menu>

  <main class="container-fluid px-4 py-3">

    <!-- Título -->
    <div class="page-title">
      <i class="fa-solid fa-box-open text-primary"></i>
      <h1 class="h4 m-0">Editar producto</h1>
    </div>

    <!-- Datos del producto -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-3 text-center">
            <img src="https://via.placeholder.com/280x280.png?text=Producto" class="img-preview" alt="Foto del producto">
            <div class="field-note mt-2">Imagen referencial</div>
          </div>
          <div class="col-md-9">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Código</label>
                <input type="text" class="form-control" value="PRD-000123" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input type="text" class="form-control" value="Producto de ejemplo">
              </div>
              <div class="col-md-6">
                <label class="form-label">Categoría</label>
                <input type="text" class="form-control" value="Almacén">
              </div>
              <div class="col-md-3">
                <label class="form-label">Precio</label>
                <input type="number" class="form-control" value="1299.99" step="0.01">
              </div>
              <div class="col-md-3">
                <label class="form-label">Stock actual</label>
                <input id="stockActual" type="number" class="form-control" value="87" readonly>
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" rows="2">Descripción corta del producto…</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sticky-actions">
        <div class="d-flex justify-content-end gap-2">
          <a href="productos.html" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-1"></i>Volver</a>
          <button class="btn btn-primary"><i class="fa-regular fa-floppy-disk me-1"></i>Guardar</button>
        </div>
      </div>
    </div>

    <!-- Movimientos de Stock -->
    <div class="card">
      <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-clipboard-list text-secondary"></i>
          <span class="fw-semibold">Movimientos de Stock</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="input-group input-group-sm" style="width: 220px;">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="searchText" type="text" class="form-control" placeholder="Buscar por tipo…">
          </div>
          <select id="pageSize" class="form-select form-select-sm" style="width:120px">
            <option value="10" selected>10 / pág.</option>
            <option value="25">25 / pág.</option>
            <option value="50">50 / pág.</option>
          </select>
        </div>
      </div>

      <div class="card-body pt-3">
        <!-- Filtros -->
        <ul class="nav nav-pills filter-pills mb-3 gap-2">
          <li class="nav-item">
            <button class="nav-link active" data-filter="all">Todos</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-filter="entradas">Entradas</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-filter="salidas">Salidas</button>
          </li>
          <li class="nav-item ms-auto">
            <span class="badge rounded-pill text-bg-light border"><i class="fa-regular fa-clock me-1"></i>Orden: más nuevo → más viejo</span>
          </li>
        </ul>

        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 140px;">Fecha</th>
                <th style="width: 180px;">Tipo</th>
                <th style="width: 120px;" class="text-end">Cantidad</th>
                <th>Observación</th>
              </tr>
            </thead>
            <tbody id="tbodyMovs"></tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="d-flex flex-wrap align-items-center justify-content-between mt-3 gap-2">
          <div class="small text-muted" id="rangeInfo">Mostrando 0–0 de 0</div>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="pager">
              <li class="page-item"><a class="page-link" data-page="prev">«</a></li>
              <li class="page-item disabled"><span class="page-link" id="pageIndicator">1 / 1</span></li>
              <li class="page-item"><a class="page-link" data-page="next">»</a></li>
            </ul>
          </nav>
        </div>

        <!-- Leyenda -->
        <div class="mt-3 small">
          <span class="me-3"><span class="badge badge-in me-1">Ingreso a depósito</span> Entrada</span>
          <span class="me-3"><span class="badge badge-in me-1">Compras</span> Entrada</span>
          <span class="me-3"><span class="badge badge-out me-1">Órdenes de Pedido</span> Salida</span>
        </div>

        <!-- Botón Ajuste de Stock (al final) -->
        <div class="d-flex justify-content-end mt-3">
          <button id="btnAjusteStock" class="btn btn-warning">
            <i class="fa-solid fa-scale-balanced me-1"></i>Ajuste de Stock
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Modal: Ajuste de Stock -->
  <div class="modal fade" id="ajusteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="frmAjuste" class="modal-content needs-validation" novalidate>
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-scale-balanced me-2"></i>Ajuste de Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="ajFecha" class="form-label">Fecha</label>
            <input type="datetime-local" id="ajFecha" class="form-control" required>
            <div class="invalid-feedback">Indicá una fecha válida.</div>
          </div>
          <div class="mb-3">
            <label for="ajCantidad" class="form-label">Cantidad</label>
            <input type="number" id="ajCantidad" class="form-control" step="1" required>
            <div class="form-text">Usá valores positivos para entrada y negativos para salida.</div>
            <div class="invalid-feedback">Ingresá una cantidad.</div>
          </div>
          <div class="mb-2">
            <label for="ajDesc" class="form-label">Descripción</label>
            <textarea id="ajDesc" class="form-control" rows="2" placeholder="Motivo del ajuste…" required></textarea>
            <div class="invalid-feedback">Ingresá una descripción.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit"><i class="fa-solid fa-check me-1"></i>Guardar ajuste</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cargar Bootstrap JS ANTES del script que usa 'bootstrap' -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Menú script -->
  <script src="menu.js"></script>

  <!-- Script principal -->
  <script>
    // === Configuración ===
    const PRODUCTO_ID = 123; // Ejemplo: reemplazá por el ID real si lo tenés.

    // TIPOS
    const TIPO_INGRESO_DEPOSITO = "Ingreso a depósito";
    const TIPO_COMPRAS = "Compras";
    const TIPO_ORDEN_PEDIDO = "Órdenes de Pedido"; // Salida

    // === Datos de ejemplo (reemplazá por fetch a tu API si corresponde) ===
    const movimientosData = [
      { MovimientoID: 1009, ProductoID: PRODUCTO_ID, Cantidad: 12,  TipoMovimiento: TIPO_COMPRAS,          Fecha: "2025-10-06T17:10:00", Observacion: "OC-8457" },
      { MovimientoID: 1008, ProductoID: PRODUCTO_ID, Cantidad: 5,   TipoMovimiento: TIPO_INGRESO_DEPOSITO, Fecha: "2025-10-06T09:23:00", Observacion: "Ajuste inventario" },
      { MovimientoID: 1007, ProductoID: PRODUCTO_ID, Cantidad: 7,   TipoMovimiento: TIPO_ORDEN_PEDIDO,     Fecha: "2025-10-05T19:40:00", Observacion: "OP-2219" },
      { MovimientoID: 1006, ProductoID: PRODUCTO_ID, Cantidad: 20,  TipoMovimiento: TIPO_COMPRAS,          Fecha: "2025-10-03T14:02:00", Observacion: "OC-8421" },
      { MovimientoID: 1005, ProductoID: PRODUCTO_ID, Cantidad: 3,   TipoMovimiento: TIPO_ORDEN_PEDIDO,     Fecha: "2025-10-02T09:00:00", Observacion: "OP-2201" },
      { MovimientoID: 1004, ProductoID: PRODUCTO_ID, Cantidad: 10,  TipoMovimiento: TIPO_INGRESO_DEPOSITO, Fecha: "2025-10-01T16:15:00", Observacion: "Devolución interna" },
      { MovimientoID: 1003, ProductoID: PRODUCTO_ID, Cantidad: 8,   TipoMovimiento: TIPO_COMPRAS,          Fecha: "2025-09-29T11:05:00", Observacion: "OC-8399" },
      { MovimientoID: 1002, ProductoID: PRODUCTO_ID, Cantidad: 6,   TipoMovimiento: TIPO_ORDEN_PEDIDO,     Fecha: "2025-09-28T18:30:00", Observacion: "OP-2188" },
      { MovimientoID: 1001, ProductoID: PRODUCTO_ID, Cantidad: 2,   TipoMovimiento: TIPO_ORDEN_PEDIDO,     Fecha: "2025-09-27T10:11:00", Observacion: "OP-2177" },
    ];

    // === Estado de UI ===
    const state = {
      raw: movimientosData.slice(),
      filtered: [],
      filter: "all", // all | entradas | salidas
      search: "",
      page: 1,
      pageSize: 10
    };

    // === Helpers ===
    function asDate(dstr){ return new Date(dstr); }
    function fmtDate(dstr){
      const d = asDate(dstr);
      const pad = n => String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function isEntrada(tipo){
      return tipo === TIPO_INGRESO_DEPOSITO || tipo === TIPO_COMPRAS;
    }
    function isSalida(tipo){
      return tipo === TIPO_ORDEN_PEDIDO;
    }
    function badgeFor(tipo){
      const isOut = isSalida(tipo);
      const cls = isOut ? "badge-out" : "badge-in";
      return `<span class="badge ${cls}">${tipo}</span>`;
    }
    function qtyHtml(m){
      const out = isSalida(m.TipoMovimiento);
      const sign = out ? "-" : "+";
      const cls = out ? "qty-out" : "qty-in";
      return `<span class="${cls}">${sign}${m.Cantidad}</span>`;
    }

    function applyFilters(){
      let arr = state.raw.filter(x => x.ProductoID === PRODUCTO_ID);

      if (state.filter === "entradas") {
        arr = arr.filter(x => isEntrada(x.TipoMovimiento));
      } else if (state.filter === "salidas") {
        arr = arr.filter(x => isSalida(x.TipoMovimiento));
      } else {
        arr = arr.filter(x => isEntrada(x.TipoMovimiento) || isSalida(x.TipoMovimiento));
      }

      const t = state.search.trim().toLowerCase();
      if (t.length > 0) {
        arr = arr.filter(x => (x.TipoMovimiento || "").toLowerCase().includes(t));
      }

      arr.sort((a,b) => asDate(b.Fecha) - asDate(a.Fecha));
      state.filtered = arr;
      const totalPages = Math.max(1, Math.ceil(arr.length / state.pageSize));
      if (state.page > totalPages) state.page = totalPages;
    }

    function renderTable(){
      const tbody = document.getElementById("tbodyMovs");
      tbody.innerHTML = "";

      const startIdx = (state.page - 1) * state.pageSize;
      const endIdx = Math.min(startIdx + state.pageSize, state.filtered.length);
      const pageItems = state.filtered.slice(startIdx, endIdx);

      for (const m of pageItems){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtDate(m.Fecha)}</td>
          <td>${badgeFor(m.TipoMovimiento)}</td>
          <td class="text-end">${qtyHtml(m)}</td>
          <td>${m.Observacion ? m.Observacion : ""}</td>
        `;
        tbody.appendChild(tr);
      }

      const rangeInfo = document.getElementById("rangeInfo");
      rangeInfo.textContent = state.filtered.length === 0
        ? "Mostrando 0–0 de 0"
        : `Mostrando ${startIdx + 1}–${endIdx} de ${state.filtered.length}`;

      const pageIndicator = document.getElementById("pageIndicator");
      const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
      pageIndicator.textContent = `${state.page} / ${totalPages}`;

      const pager = document.getElementById("pager");
      const prevItem = pager.querySelector('[data-page="prev"]').closest(".page-item");
      const nextItem = pager.querySelector('[data-page="next"]').closest(".page-item");
      prevItem.classList.toggle("disabled", state.page <= 1);
      nextItem.classList.toggle("disabled", state.page >= totalPages);
    }

    function render(){
      applyFilters();
      renderTable();
    }

    // === Ajuste de Stock ===
    const ajusteModal = new bootstrap.Modal('#ajusteModal');

    document.getElementById('btnAjusteStock').addEventListener('click', ()=>{
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      document.getElementById('ajFecha').value = local;
      document.getElementById('ajCantidad').value = '';
      document.getElementById('ajDesc').value = '';
      document.getElementById('frmAjuste').classList.remove('was-validated');
      ajusteModal.show();
    });

    document.getElementById('frmAjuste').addEventListener('submit', (e)=>{
      e.preventDefault();
      const form = e.currentTarget;
      if(!form.checkValidity()){
        form.classList.add('was-validated');
        return;
      }

      const fechaStr = document.getElementById('ajFecha').value;
      const cantidad = parseInt(document.getElementById('ajCantidad').value, 10);
      const desc = document.getElementById('ajDesc').value.trim();

      const tipo = (cantidad < 0) ? TIPO_ORDEN_PEDIDO : TIPO_INGRESO_DEPOSITO;

      const nextId = (state.raw.reduce((max,m)=>Math.max(max, m.MovimientoID), 1000) + 1);
      const isoFecha = new Date(fechaStr).toISOString();

      state.raw.push({
        MovimientoID: nextId,
        ProductoID: PRODUCTO_ID,
        Cantidad: Math.abs(cantidad),
        TipoMovimiento: tipo,
        Fecha: isoFecha,
        Observacion: desc ? `Ajuste: ${desc}` : "Ajuste de stock"
      });

      // Actualizar stock actual (visual)
      const stockInput = document.getElementById('stockActual');
      const current = parseInt(stockInput.value || "0", 10);
      stockInput.value = current + cantidad;

      render();
      ajusteModal.hide();
    });

    // === Eventos UI ===
    document.querySelectorAll(".filter-pills .nav-link").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".filter-pills .nav-link").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        state.filter = btn.dataset.filter;
        state.page = 1;
        render();
      });
    });

    document.getElementById("searchText").addEventListener("input", (e)=>{
      state.search = e.target.value || "";
      state.page = 1;
      render();
    });

    document.getElementById("pageSize").addEventListener("change", (e)=>{
      state.pageSize = parseInt(e.target.value, 10) || 10;
      state.page = 1;
      render();
    });

    document.getElementById("pager").addEventListener("click", (e)=>{
      const a = e.target.closest(".page-link");
      if (!a) return;
      const action = a.dataset.page;
      if (!action) return;

      const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
      if (action === "prev" && state.page > 1) {
        state.page--;
      } else if (action === "next" && state.page < totalPages) {
        state.page++;
      }
      renderTable();
    });

    // === Init ===
    render();
  </script>
</body>
</html>
